[id="cnf-best-practices-far-edge-how-to-deploy-and-configure-ptp"]
= How to deploy and configure PTP

Before enabling PTP, ensure that NTP is disabled for the required nodes. This can be done by disabling the `chrony` time service (`chronyd`) using a `MachineConfig` custom resource. For more information, see link:https://docs.openshift.com/container-platform/latest/post_installation_configuration/machine-configuration-tasks.html#cnf-disable-chronyd_post-install-machine-configuration-tasks[Disabling chrony time service].

After disabling the NTP service, the next thing is to properly assign labels to the cluster nodes. Labels ensure that the PTP operator applies PTP profiles to the correct cluster node. The use of labels facilitates in-cluster object searches, which are leveraged by the PTP operator (using a match field) to select the right cluster nodes and configure the `ptp4l` and `phc2sys` programs accordingly. See the following examples:

[source,terminal]
----
$ oc label node rh-sno-du ptp/boundary-clock="" # <- context: rh-sno-du cluster
----

[source,terminal]
----
$ oc label node rh-sno-ru ptp/ordinary-clock="" # <- context: rh-sno-ru cluster
----

These labels are used by the `match` field in `PtpConfig` CR to match a profile to one or more nodes.

Configuring PTP is a matter of link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#install-ptp-operator-cli_using-ptp[installing the PTP Operator], link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#discover-ptp-devices_using-ptp[selecting a capable NIC using the `NodePtpDevice` CR] and setting up the `PtpConfig` CR with the appropriate values to work as:

* An link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#configuring-linuxptp-services-as-ordinary-clock_using-ptp[OC in an RU]
* A link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#configuring-linuxptp-services-as-boundary-clock_using-ptp[BC in a vDU]

Notice, however, that to fulfill Far Edge requirements regarding low latency the PTP Operator `linuxptp` services link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#cnf-configuring-fifo-priority-scheduling-for-ptp_using-ptp[must be set to allow threads to run with a SCHED_FIFO policy].

The follow topology illustrates the PTP operator running on cluster nodes where the O-RAN workloads are hosted:

.Running O-RAN cluster workloads
image:image2_far_edge.png[width=518,height=408]

The GM device sends its timestamps downstream and these are received in the boundary clock slave ports of a vDU (denoted in the image with a capital S). These timestamps are then used by the `ptp4l` program to adjust the local `PHC` in the corresponding cluster node. This also happens from the vDU master ports toward RU ordinary clocks slave ports.

At the same time, the `phc2sys` process running in both the O-DU and O-RU nodes read the PHC timestamps from the `ptp4l` program through a shared https://en.wikipedia.org/wiki/Unix_domain_socket[Unix Domain Socket] (UDS) and finally adjusting the `SYSTEM_CLOCK` offset, as shown in the figure below.

This process is continuously repeated keeping all the `PHC` instances in the O-RAN deployment effectively synchronized to the GNSS source clock, which acts as the GM in this scenario.

image:image3_far_edge.png[width=606,height=419]

Tested hardware::

Supported NICs have their own physical on-board clock (known as PHC - PTP Hardware Clock) that is used to hardware-timestamp the incoming and outgoing PTP messages.

The recommended NICs with hardware PTP support are:

[width="100%",cols="51%,49%",options="header",]
|===
|Vendor |PTP Profile setting
|Intel Columbiaville 800 Series NICs |Ensure _boundary_clock_jbod_ is set to 0.
|Intel Fortville X710 Series NICs |Ensure _boundary_clock_jbod_ is set to 1.
|===

Fast event detection::

Cloud-native applications, such as virtual RAN (vRAN), require quick access to notifications about hardware timing events. This is critical for the proper functioning of the whole Far Edge network. link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#ptp-hardware-fast-event-notifications-framework[Fast event notifications] is a Red Hat framework that enables early warnings on real-time PTP clock synchronization events.

This framework mitigates workload errors by allowing cluster nodes to directly communicate PTP clock sync status to the vRAN application running as part of the DU. These event notifications are available to RAN applications running on the same DU node using a publish/subscribe REST API approach that provides event notifications via a fast messaging bus.

Fast event notifications are generated by the PTP Operator in the OpenShift Container Platform for every PTP-capable network interface. Specifically, it uses an AMQP event notification bus provided by the AMQ Interconnect Operator that delivers flexible routing of messages between any AMQP-enabled endpoints. A high-level overview of the PTP fast events framework is below:

.Overview of the PTP fast events framework
image:image4_far_edge.png[width=627,height=361]

From the Openshift PTP perspective, the idea is to link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#cnf-installing-amq-interconnect-messaging-bus_using-ptp[[install the AMQ Interconnect Operator] and configure link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#cnf-configuring-the-ptp-fast-event-publisher_using-ptp[the PTP Operator].

Then, update the `PtpConfig` CR to include the relevant values in each case (sample values for `ptpClockThreshold` are shown below):

[source,yaml]
----
apiVersion: ptp.openshift.io/v1
kind: PtpConfig
metadata:
  name: <ptp_config_name>
  namespace: openshift-ptp
...
spec:
  profile:
    - name: "profile1"
      interface: "enp5s0f0"
      ptp4lOpts: "-2 -s --summary_interval -4"
      phc2sysOpts: "-a -r -m -n 24 -N 8 -R 16"
      ptp4lConf: ""
  ptpClockThreshold:
    holdOverTimeout: 5
    maxOffsetThreshold: 100
    minOffsetThreshold: -100
----

[NOTE]
====
If the `ptpClockThreshold` stanza is not present, default values are applied for the `ptpClockThreshold` fields.
====

The `ptpClockThreshold` configures how long the PTP operator should wait after losing the PTP master clock signal, triggering that error as a PTP event:

* `holdOverTimeout` is the time value (in seconds) before the PTP clock event state changes to `FREERUN`, which means that synchronization from the PTP master clock is lost.

* `maxOffsetThreshold` and `minOffsetThreshold` settings configure the offset values (in nanoseconds) that compare against the values for CLOCK_REALTIME (`phc2sys`) or master offset (`ptp4l`). When the `ptp4l` or `phc2sys` offset value is outside the specified range, the PTP clock state is then set to `FREERUN`. When the offset value is within this range, the PTP clock state remains set to `LOCKED`.

From the DU application perspective, a new `cloud-event-proxy` sidecar container is appended to the DU application Pod that is loosely coupled to the main DU application container on the DU node. It provides an event publishing framework that allows you to subscribe to DU applications to any published PTP event. A detailed explanation of how it works can be found link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#cnf-about-ptp-fast-event-notifications-framework_using-ptp[here].

The steps to get a DU application subscribed are described link:https://docs.openshift.com/container-platform/latest/networking/using-ptp.html#cnf-fast-event-notifications-api-refererence_using-ptp[here], along with several examples of use.

